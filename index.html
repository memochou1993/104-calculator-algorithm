<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
</head>
<body>
  <div
    id="app"
  >
    <v-app>
      <v-content>
        <v-container
          grid-list-xl
        >
          <v-layout
            row
            wrap
          >
            <v-flex
              xs12
            >
              <v-card>
                <form
                  @submit.prevent="submit"
                >
                  <v-card-text>
                    <v-layout
                      row
                      wrap
                    >
                      <v-flex
                        v-for="(group, index) in fields"
                        :key="index"
                      >
                        <v-subheader
                          class="px-0"
                          v-text="group.name"
                        ></v-subheader>
                        <div
                          v-for="(field, index) in group.items"
                          :key="index"
                        >
                          <v-text-field
                            v-model="field.model"
                            :label="field.label"
                            mask="###"
                            suffix="%"
                          ></v-text-field>
                        </div>
                      </v-flex>
                      <v-flex>
                          <v-subheader
                            class="px-0"
                          >
                            應徵人數
                          </v-subheader>
                          <v-select
                          v-model="candidate.value"
                          :items="candidates"
                          item-text="label"
                          item-value="value"
                          append-icon=""
                        ></v-select>
                        <v-btn
                          block
                          type="submit"
                          color="indigo"
                          class="white--text"
                        >
                          計算
                        </v-btn>
                      </v-flex>
                    </v-layout>
                  </v-card-text>
                </form>
              </v-card>
            </v-flex>
          </v-layout>
          <v-layout
            row
            wrap
          >
            <v-flex
              v-if="groups.length"
              v-for="(group, i) in groups"
              :key="i"
              sm6
              xs12
            >
              <v-card
                height="100%"
              >
                <v-card-text>
                  <v-layout
                    column
                  >
                    <v-flex>
                      <h3
                        class="headline mb-0"
                        v-text="group.name"
                      ></h3>
                    </v-flex>
                    <v-divider></v-divider>
                    <v-flex
                      v-for="(item, i) in group.items"
                      :key="i"
                    >
                      <v-layout
                        row
                        wrap
                        align-center
                      >
                        <v-flex
                          sm2
                          xs12
                          class="py-1 text-sm-right"
                        >
                          <div
                            v-text="item.name"
                          ></div>
                        </v-flex>
                        <v-flex
                          sm8
                          xs10
                          class="py-1"
                        >
                          <v-progress-linear
                            height="15"
                            color="amber"
                            :value="percentage(item.value, total)"
                          />
                        </v-flex>
                        <v-flex
                          sm2
                          xs2
                          class="py-1"
                        >
                          <div
                            v-text="`${item.value} 人`"
                          ></div>
                        </v-flex>
                      </v-layout>
                    </v-flex>
                  </v-layout>
                </v-card-text>
              </v-card>
            </v-flex>
          </v-layout>
        </v-container>
      </v-content>
    </v-app>
  </div>
  
  <script>
    new Vue({
      el: '#app',
      data: {
        candidate: {
          label: '1-5 人',
          value: {
            min: 1,
            max: 5,
          },
        },
        candidates: [
          {
            label: '1-5 人',
            value: {
              min: 1,
              max: 5,
            },
          },
          {
            label: '6-10 人',
            value: {
              min: 6,
              max: 10,
            },
          },
          {
            label: '11-30 人',
            value: {
              min: 11,
              max: 30,
            },
          },
        ],
        fields: [
          {
            name: '性別分布',
            items: [
              {
                model: '',
                label: '男',
              },
              {
                model: '',
                label: '女',
              },
            ],
          },
          {
            name: '學歷分布',
            items: [
              {
                model: '',
                label: '博碩士',
              },
              {
                model: '',
                label: '大學',
              },
              {
                model: '',
                label: '專科',
              },
              {
                model: '',
                label: '高中職',
              },
              {
                model: '',
                label: '國中以下',
              },
            ],
          },
          {
            name: '年齡分布',
            items: [
              {
                model: '',
                label: '20 歲以下',
              },
              {
                model: '',
                label: '21-25 歲',
              },
              {
                model: '',
                label: '26-30 歲',
              },
              {
                model: '',
                label: '31-35 歲',
              },
              {
                model: '',
                label: '36-40 歲',
              },
              {
                model: '',
                label: '41-45 歲',
              },
              {
                model: '',
                label: '46-50 歲',
              },
              {
                model: '',
                label: '51-55 歲',
              },
              {
                model: '',
                label: '56-60 歲',
              },
              {
                model: '',
                label: '60 歲以上',
              },
            ],
          },
          {
            name: '工作經驗分布',
              items: [
              {
                model: '',
                label: '無工作經驗',
              },
              {
                model: '',
                label: '1 年以下',
              },
              {
                model: '',
                label: '1-3 年',
              },
              {
                model: '',
                label: '3-5 年',
              },
              {
                model: '',
                label: '5-10 年',
              },
              {
                model: '',
                label: '10-15 年',
              },
              {
                model: '',
                label: '15-20 年',
              },
              {
                model: '',
                label: '20-25 年',
              },
              {
                model: '',
                label: '25 年以上',
              },
            ],
          },
        ],
        values: [
          [0],
          [0],
          [0],
          [0],
        ],
      },
      computed: {
        total() {
          if (!this.values.length) {
            return 0;
          }
          return this.analyze(this.values).total;
        },
        groups() {
          if (!this.total) {
            return [];
          }
          return this.associate(this.fields, this.convert(this.values, {
            total: this.total,
          })).filter((element) => {
            return !this.empty(element);
          });
        },
        results() {
          return this.fields.map((row) => {
            const results = row.items.map((column) => {
              return parseInt(column.model || 0, 10) / 100;
            });
            return results.some((element) => element !== 0) ? results : [0];
          });
        },
      },
      methods: {
        associate(keys, values) {
          return keys.map((key, index) => {
            return {
              name: key.name,
              items: values[index].map((value, index) => {
                return {
                  name: key.items[index].label,
                  value,
                };
              }),
            };
          });
        },
        empty(object) {
          return object.items.length === 1 && !object.items[0].value;
        },
        analyze(array, {
          index = 0,
        } = {}) {
          return this.unique(this.max([].concat(...array.map((element) => this.calculate(element, this.candidate.value)))))[index];
        },
        convert(array, {
          total = 0,
        } = {}) {
          return array.map((row) => {
            return row.map(column => Math.round(column * total));
          });
        },
        max(array) {
          return array.filter((element) => {
            return element.divisible === Math.max(...array.map((element) => element.divisible));
          });
        },
        unique(array) {
          return array.filter((element, index) => {
            return index === array.findIndex((object) => {
              return JSON.stringify(object) === JSON.stringify(element);
            });
          });
        },
        range(min, max) {
          return Array.from(
            {
              length: max - min + 1,
            },
            (_, i) => min + i,
          );
        },
        percentage(value, total) {
          return value / total * 100;
        },
        calculate(array, {
          min = 11,
          max = 30,
        } = {}) {
          return this.range(min, max).map((index) => {
            const total = array.reduce((accumulator, element) => {
              const value = Math.round(element * index);
              return accumulator + value;
            }, 0);
            const divisible = array.reduce((accumulator, element) => {
              const value = Math.round(element * index % 1 * 10) / 10 % 1 === 0 ? 1 : 0;
              return accumulator + value;
            }, 0);
            return {
              total: total <= max ? total : 0,
              divisible: total <= max ? divisible : 0,
            };
          });
        },
        submit() {
          this.values = this.results;
        },
      },
    });
  </script>
</body>
</html>
